{% extends "base.html" %}

{% block title %}Medical Records - PetPal{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-file-medical text-info"></i> Medical Records</h1>
    <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#addMedicalModal">
        <i class="bi bi-plus-circle"></i> Add Medical Record
    </button>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title text-info">Total Records</h5>
                <h2 id="totalRecords" class="text-info">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title text-success">Vaccinations</h5>
                <h2 id="vaccinationCount" class="text-success">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title text-warning">Check-ups</h5>
                <h2 id="checkupCount" class="text-warning">0</h2>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">Medical History</h5>
            </div>
            <div class="col-auto">
                <div class="row g-2">
                    <div class="col-auto">
                        <select class="form-select form-select-sm" id="petFilter">
                            <option value="">All Pets</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <select class="form-select form-select-sm" id="typeFilter">
                            <option value="">All Types</option>
                            <option value="vaccination">Vaccination</option>
                            <option value="checkup">Check-up</option>
                            <option value="surgery">Surgery</option>
                            <option value="emergency">Emergency</option>
                            <option value="dental">Dental</option>
                            <option value="grooming">Grooming</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div id="medicalContainer">
            <!-- Medical records will be loaded here -->
        </div>
    </div>
</div>

<!-- Add Medical Record Modal -->
<div class="modal fade" id="addMedicalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Medical Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addMedicalForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="petSelect" class="form-label">Select Pet</label>
                            <select class="form-select" id="petSelect" name="pet_id" required>
                                <option value="">Choose a pet...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="recordType" class="form-label">Record Type</label>
                            <select class="form-select" id="recordType" name="record_type" required>
                                <option value="">Select type...</option>
                                <option value="vaccination">Vaccination</option>
                                <option value="checkup">Check-up</option>
                                <option value="surgery">Surgery</option>
                                <option value="emergency">Emergency</option>
                                <option value="dental">Dental</option>
                                <option value="grooming">Grooming</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="visitDate" class="form-label">Visit Date</label>
                            <input type="date" class="form-control" id="visitDate" name="visit_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="veterinarian" class="form-label">Veterinarian</label>
                            <input type="text" class="form-control" id="veterinarian" name="veterinarian" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="clinic" class="form-label">Clinic/Hospital</label>
                        <input type="text" class="form-control" id="clinic" name="clinic">
                    </div>
                    <div class="mb-3">
                        <label for="diagnosis" class="form-label">Diagnosis/Description</label>
                        <textarea class="form-control" id="diagnosis" name="diagnosis" rows="3" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="treatment" class="form-label">Treatment</label>
                            <textarea class="form-control" id="treatment" name="treatment" rows="2"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="medications" class="form-label">Medications</label>
                            <textarea class="form-control" id="medications" name="medications" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="weight" class="form-label">Weight (kg)</label>
                            <input type="number" class="form-control" id="weight" name="weight" step="0.1" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="temperature" class="form-label">Temperature (°C)</label>
                            <input type="number" class="form-control" id="temperature" name="temperature" step="0.1">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Additional Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="followUp" class="form-label">Follow-up Date</label>
                        <input type="date" class="form-control" id="followUp" name="follow_up_date">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="saveMedicalBtn">Save Record</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Medical Record Modal -->
<div class="modal fade" id="editMedicalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Medical Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editMedicalForm">
                    <input type="hidden" id="editRecordId" name="id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editPetSelect" class="form-label">Select Pet</label>
                            <select class="form-select" id="editPetSelect" name="pet_id" required>
                                <option value="">Choose a pet...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editRecordType" class="form-label">Record Type</label>
                            <select class="form-select" id="editRecordType" name="record_type" required>
                                <option value="">Select type...</option>
                                <option value="vaccination">Vaccination</option>
                                <option value="checkup">Check-up</option>
                                <option value="surgery">Surgery</option>
                                <option value="emergency">Emergency</option>
                                <option value="dental">Dental</option>
                                <option value="grooming">Grooming</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editVisitDate" class="form-label">Visit Date</label>
                            <input type="date" class="form-control" id="editVisitDate" name="visit_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editVeterinarian" class="form-label">Veterinarian</label>
                            <input type="text" class="form-control" id="editVeterinarian" name="veterinarian" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editClinic" class="form-label">Clinic/Hospital</label>
                        <input type="text" class="form-control" id="editClinic" name="clinic">
                    </div>
                    <div class="mb-3">
                        <label for="editDiagnosis" class="form-label">Diagnosis/Description</label>
                        <textarea class="form-control" id="editDiagnosis" name="diagnosis" rows="3" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editTreatment" class="form-label">Treatment</label>
                            <textarea class="form-control" id="editTreatment" name="treatment" rows="2"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editMedications" class="form-label">Medications</label>
                            <textarea class="form-control" id="editMedications" name="medications" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editWeight" class="form-label">Weight (kg)</label>
                            <input type="number" class="form-control" id="editWeight" name="weight" step="0.1" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editTemperature" class="form-label">Temperature (°C)</label>
                            <input type="number" class="form-control" id="editTemperature" name="temperature" step="0.1">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editNotes" class="form-label">Additional Notes</label>
                        <textarea class="form-control" id="editNotes" name="notes" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editFollowUp" class="form-label">Follow-up Date</label>
                        <input type="date" class="form-control" id="editFollowUp" name="follow_up_date">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="updateMedicalBtn">Update Record</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let medicalRecords = [];
let pets = [];

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPets();
    loadMedicalRecords();
});

// Load pets for dropdown
async function loadPets() {
    try {
        const response = await fetch('/api/pets/');
        if (response.ok) {
            pets = await response.json();
            populatePetDropdowns();
            populatePetFilter();
        }
    } catch (error) {
        console.error('Error loading pets:', error);
    }
}

// Populate pet dropdowns
function populatePetDropdowns() {
    const selects = [document.getElementById('petSelect'), document.getElementById('editPetSelect')];
    
    selects.forEach(select => {
        const currentValue = select.value;
        select.innerHTML = '<option value="">Choose a pet...</option>';
        
        pets.forEach(pet => {
            const option = document.createElement('option');
            option.value = pet._id;
            option.textContent = `${pet.name} (${pet.species})`;
            select.appendChild(option);
        });
        
        if (currentValue) {
            select.value = currentValue;
        }
    });
}

// Populate pet filter
function populatePetFilter() {
    const filter = document.getElementById('petFilter');
    filter.innerHTML = '<option value="">All Pets</option>';
    
    pets.forEach(pet => {
        const option = document.createElement('option');
        option.value = pet._id;
        option.textContent = pet.name;
        filter.appendChild(option);
    });
}

// Load medical records
async function loadMedicalRecords() {
    try {
        const response = await fetch('/api/medical/');
        if (response.ok) {
            medicalRecords = await response.json();
            displayMedicalRecords();
            updateCounts();
        } else {
            const error = await response.json();
            showAlert(error.message || 'Failed to load medical records', 'danger');
        }
    } catch (error) {
        showAlert('Error loading medical records', 'danger');
    }
}

// Display medical records
function displayMedicalRecords() {
    const container = document.getElementById('medicalContainer');
    const petFilter = document.getElementById('petFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    
    let filteredRecords = medicalRecords;
    
    if (petFilter) {
        filteredRecords = filteredRecords.filter(record => record.pet_id === petFilter);
    }
    
    if (typeFilter) {
        filteredRecords = filteredRecords.filter(record => record.record_type === typeFilter);
    }
    
    if (filteredRecords.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="bi bi-file-medical text-muted" style="font-size: 3rem;"></i>
                <h4 class="text-muted mt-3">No medical records found</h4>
                <p class="text-muted">Add your first medical record to get started!</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Pet</th>
                        <th>Type</th>
                        <th>Diagnosis</th>
                        <th>Veterinarian</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredRecords.map(record => {
                        const pet = pets.find(p => p._id === record.pet_id);
                        const date = new Date(record.visit_date);
                        const typeClass = getTypeClass(record.record_type);
                        
                        return `
                            <tr>
                                <td>${date.toLocaleDateString()}</td>
                                <td>${pet ? pet.name : 'Unknown'}</td>
                                <td><span class="badge ${typeClass}">${record.record_type.charAt(0).toUpperCase() + record.record_type.slice(1)}</span></td>
                                <td>
                                    <div>${record.diagnosis}</div>
                                    ${record.treatment ? `<small class="text-muted">Treatment: ${record.treatment}</small>` : ''}
                                </td>
                                <td>Dr. ${record.veterinarian}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-info" onclick="viewRecord('${record._id}')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="editRecord('${record._id}')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteRecord('${record._id}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// Get type badge class
function getTypeClass(type) {
    switch (type) {
        case 'vaccination': return 'bg-success';
        case 'checkup': return 'bg-warning';
        case 'surgery': return 'bg-danger';
        case 'emergency': return 'bg-dark';
        case 'dental': return 'bg-info';
        case 'grooming': return 'bg-secondary';
        default: return 'bg-primary';
    }
}

// Update counts
function updateCounts() {
    const vaccinations = medicalRecords.filter(r => r.record_type === 'vaccination').length;
    const checkups = medicalRecords.filter(r => r.record_type === 'checkup').length;
    
    document.getElementById('totalRecords').textContent = medicalRecords.length;
    document.getElementById('vaccinationCount').textContent = vaccinations;
    document.getElementById('checkupCount').textContent = checkups;
}

// Filter change events
document.getElementById('petFilter').addEventListener('change', displayMedicalRecords);
document.getElementById('typeFilter').addEventListener('change', displayMedicalRecords);

// Save new medical record
document.getElementById('saveMedicalBtn').addEventListener('click', async function() {
    const form = document.getElementById('addMedicalForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Convert numeric fields
    if (data.weight) {
        data.weight = parseFloat(data.weight);
    }
    if (data.temperature) {
        data.temperature = parseFloat(data.temperature);
    }
    
    // Remove empty fields
    Object.keys(data).forEach(key => {
        if (data[key] === '') {
            delete data[key];
        }
    });
    
    try {
        const response = await fetch('/api/medical/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.status === 201) {
            showAlert('Medical record added successfully!', 'success');
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('addMedicalModal')).hide();
            loadMedicalRecords();
        } else {
            showAlert(result.message || 'Failed to add medical record', 'danger');
        }
    } catch (error) {
        showAlert('Error adding medical record', 'danger');
    }
});

// View record details
function viewRecord(recordId) {
    const record = medicalRecords.find(r => r._id === recordId);
    const pet = pets.find(p => p._id === record.pet_id);
    
    if (!record) return;
    
    const date = new Date(record.visit_date);
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6>Pet:</h6>
                <p>${pet ? pet.name : 'Unknown'}</p>
                
                <h6>Date:</h6>
                <p>${date.toLocaleDateString()}</p>
                
                <h6>Type:</h6>
                <p><span class="badge ${getTypeClass(record.record_type)}">${record.record_type.charAt(0).toUpperCase() + record.record_type.slice(1)}</span></p>
                
                <h6>Veterinarian:</h6>
                <p>Dr. ${record.veterinarian}</p>
                
                ${record.clinic ? `<h6>Clinic:</h6><p>${record.clinic}</p>` : ''}
            </div>
            <div class="col-md-6">
                <h6>Diagnosis:</h6>
                <p>${record.diagnosis}</p>
                
                ${record.treatment ? `<h6>Treatment:</h6><p>${record.treatment}</p>` : ''}
                
                ${record.medications ? `<h6>Medications:</h6><p>${record.medications}</p>` : ''}
                
                ${record.weight ? `<h6>Weight:</h6><p>${record.weight} kg</p>` : ''}
                
                ${record.temperature ? `<h6>Temperature:</h6><p>${record.temperature}°C</p>` : ''}
                
                ${record.notes ? `<h6>Notes:</h6><p>${record.notes}</p>` : ''}
                
                ${record.follow_up_date ? `<h6>Follow-up:</h6><p>${new Date(record.follow_up_date).toLocaleDateString()}</p>` : ''}
            </div>
        </div>
    `;
    
    showAlert(content, 'info', 0);
}

// Edit record
function editRecord(recordId) {
    const record = medicalRecords.find(r => r._id === recordId);
    if (!record) return;
    
    document.getElementById('editRecordId').value = record._id;
    document.getElementById('editPetSelect').value = record.pet_id;
    document.getElementById('editRecordType').value = record.record_type;
    document.getElementById('editVisitDate').value = record.visit_date.split('T')[0];
    document.getElementById('editVeterinarian').value = record.veterinarian;
    document.getElementById('editClinic').value = record.clinic || '';
    document.getElementById('editDiagnosis').value = record.diagnosis;
    document.getElementById('editTreatment').value = record.treatment || '';
    document.getElementById('editMedications').value = record.medications || '';
    document.getElementById('editWeight').value = record.weight || '';
    document.getElementById('editTemperature').value = record.temperature || '';
    document.getElementById('editNotes').value = record.notes || '';
    document.getElementById('editFollowUp').value = record.follow_up_date ? record.follow_up_date.split('T')[0] : '';
    
    new bootstrap.Modal(document.getElementById('editMedicalModal')).show();
}

// Update medical record
document.getElementById('updateMedicalBtn').addEventListener('click', async function() {
    const form = document.getElementById('editMedicalForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    const recordId = data.id;
    delete data.id;
    
    // Remove empty fields
    Object.keys(data).forEach(key => {
        if (data[key] === '') {
            delete data[key];
        }
    });
    
    try {
        const response = await fetch(`/api/medical/${recordId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showAlert('Medical record updated successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editMedicalModal')).hide();
            loadMedicalRecords();
        } else {
            const result = await response.json();
            showAlert(result.message, 'danger');
        }
    } catch (error) {
        showAlert('Error updating medical record', 'danger');
    }
});

// Delete record
async function deleteRecord(recordId) {
    if (!confirm('Are you sure you want to delete this medical record?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/medical/${recordId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showAlert('Medical record deleted successfully', 'success');
            loadMedicalRecords();
        } else {
            const result = await response.json();
            showAlert(result.message, 'danger');
        }
    } catch (error) {
        showAlert('Error deleting medical record', 'danger');
    }
}
</script>
{% endblock %}