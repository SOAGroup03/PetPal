{% extends "base.html" %}

{% block title %}Appointments - PetPal{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-calendar-check text-success"></i> Appointments</h1>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addAppointmentModal">
        <i class="bi bi-plus-circle"></i> Schedule Appointment
    </button>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title text-success">Upcoming Appointments</h5>
                <h2 id="upcomingCount" class="text-success">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title text-info">Total Appointments</h5>
                <h2 id="totalCount" class="text-info">0</h2>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">All Appointments</h5>
            </div>
            <div class="col-auto">
                <select class="form-select form-select-sm" id="statusFilter">
                    <option value="">All Status</option>
                    <option value="scheduled">Scheduled</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div id="appointmentsContainer">
            <!-- Appointments will be loaded here -->
        </div>
    </div>
</div>

<!-- Add Appointment Modal -->
<div class="modal fade" id="addAppointmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Schedule New Appointment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addAppointmentForm">
                    <div class="mb-3">
                        <label for="petSelect" class="form-label">Select Pet</label>
                        <select class="form-select" id="petSelect" name="pet_id" required>
                            <option value="">Choose a pet...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="appointmentType" class="form-label">Appointment Type</label>
                        <select class="form-select" id="appointmentType" name="appointment_type" required>
                            <option value="">Select type...</option>
                            <option value="Check-up">General Check-up</option>
                            <option value="Vaccination">Vaccination</option>
                            <option value="Surgery">Surgery</option>
                            <option value="Dental">Dental Care</option>
                            <option value="Emergency">Emergency</option>
                            <option value="Grooming">Grooming</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="appointmentDate" class="form-label">Date & Time</label>
                        <input type="datetime-local" class="form-control" id="appointmentDate" name="appointment_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="veterinarian" class="form-label">Veterinarian</label>
                        <input type="text" class="form-control" id="veterinarian" name="veterinarian" required>
                    </div>
                    <div class="mb-3">
                        <label for="clinic" class="form-label">Clinic/Hospital</label>
                        <input type="text" class="form-control" id="clinic" name="clinic">
                    </div>
                    <div class="mb-3">
                        <label for="reason" class="form-label">Reason for Visit</label>
                        <textarea class="form-control" id="reason" name="reason" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="scheduled">Scheduled</option>
                            <option value="confirmed">Confirmed</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="saveAppointmentBtn">Schedule Appointment</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Appointment Modal -->
<div class="modal fade" id="editAppointmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Appointment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editAppointmentForm">
                    <input type="hidden" id="editAppointmentId" name="id">
                    <div class="mb-3">
                        <label for="editPetSelect" class="form-label">Select Pet</label>
                        <select class="form-select" id="editPetSelect" name="pet_id" required>
                            <option value="">Choose a pet...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editAppointmentType" class="form-label">Appointment Type</label>
                        <select class="form-select" id="editAppointmentType" name="appointment_type" required>
                            <option value="">Select type...</option>
                            <option value="Check-up">General Check-up</option>
                            <option value="Vaccination">Vaccination</option>
                            <option value="Surgery">Surgery</option>
                            <option value="Dental">Dental Care</option>
                            <option value="Emergency">Emergency</option>
                            <option value="Grooming">Grooming</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editAppointmentDate" class="form-label">Date & Time</label>
                        <input type="datetime-local" class="form-control" id="editAppointmentDate" name="appointment_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="editVeterinarian" class="form-label">Veterinarian</label>
                        <input type="text" class="form-control" id="editVeterinarian" name="veterinarian" required>
                    </div>
                    <div class="mb-3">
                        <label for="editClinic" class="form-label">Clinic/Hospital</label>
                        <input type="text" class="form-control" id="editClinic" name="clinic">
                    </div>
                    <div class="mb-3">
                        <label for="editReason" class="form-label">Reason for Visit</label>
                        <textarea class="form-control" id="editReason" name="reason" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editStatus" class="form-label">Status</label>
                        <select class="form-select" id="editStatus" name="status">
                            <option value="scheduled">Scheduled</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="updateAppointmentBtn">Update Appointment</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let appointments = [];
let pets = [];

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPets();
    loadAppointments();
    
    // Set minimum date to today
    const now = new Date();
    const dateString = now.toISOString().slice(0, 16);
    document.getElementById('appointmentDate').min = dateString;
    document.getElementById('editAppointmentDate').min = dateString;
});

// Load pets for dropdown
async function loadPets() {
    try {
        const response = await fetch('/api/pets/');
        if (response.ok) {
            pets = await response.json();
            populatePetDropdowns();
        }
    } catch (error) {
        console.error('Error loading pets:', error);
    }
}

// Populate pet dropdowns
function populatePetDropdowns() {
    const selects = [document.getElementById('petSelect'), document.getElementById('editPetSelect')];
    
    selects.forEach(select => {
        const currentValue = select.value;
        select.innerHTML = '<option value="">Choose a pet...</option>';
        
        pets.forEach(pet => {
            const option = document.createElement('option');
            option.value = pet._id;
            option.textContent = `${pet.name} (${pet.species})`;
            select.appendChild(option);
        });
        
        if (currentValue) {
            select.value = currentValue;
        }
    });
}

// Load appointments
async function loadAppointments() {
    try {
        const response = await fetch('/api/appointments/');
        if (response.ok) {
            appointments = await response.json();
            displayAppointments();
            updateCounts();
        } else {
            showAlert('Failed to load appointments', 'danger');
        }
    } catch (error) {
        showAlert('Error loading appointments', 'danger');
    }
}

// Display appointments
function displayAppointments() {
    const container = document.getElementById('appointmentsContainer');
    const statusFilter = document.getElementById('statusFilter').value;
    
    let filteredAppointments = appointments;
    if (statusFilter) {
        filteredAppointments = appointments.filter(apt => apt.status === statusFilter);
    }
    
    if (filteredAppointments.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="bi bi-calendar text-muted" style="font-size: 3rem;"></i>
                <h4 class="text-muted mt-3">No appointments found</h4>
                <p class="text-muted">Schedule your first appointment to get started!</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date & Time</th>
                        <th>Pet</th>
                        <th>Type</th>
                        <th>Veterinarian</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredAppointments.map(appointment => {
                        const pet = pets.find(p => p._id === appointment.pet_id);
                        const date = new Date(appointment.appointment_date);
                        const statusClass = getStatusClass(appointment.status);
                        
                        return `
                            <tr>
                                <td>
                                    <div>${date.toLocaleDateString()}</div>
                                    <small class="text-muted">${date.toLocaleTimeString()}</small>
                                </td>
                                <td>${pet ? pet.name : 'Unknown'}</td>
                                <td><span class="badge bg-info">${appointment.appointment_type}</span></td>
                                <td>Dr. ${appointment.veterinarian}</td>
                                <td><span class="badge ${statusClass}">${appointment.status.charAt(0).toUpperCase() + appointment.status.slice(1)}</span></td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="editAppointment('${appointment._id}')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteAppointment('${appointment._id}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// Get status badge class
function getStatusClass(status) {
    switch (status) {
        case 'scheduled': return 'bg-warning';
        case 'confirmed': return 'bg-primary';
        case 'completed': return 'bg-success';
        case 'cancelled': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

// Update counts
function updateCounts() {
    const now = new Date();
    const upcoming = appointments.filter(apt => 
        new Date(apt.appointment_date) > now && 
        (apt.status === 'scheduled' || apt.status === 'confirmed')
    ).length;
    
    document.getElementById('upcomingCount').textContent = upcoming;
    document.getElementById('totalCount').textContent = appointments.length;
}

// Status filter change
document.getElementById('statusFilter').addEventListener('change', displayAppointments);

// Save new appointment
document.getElementById('saveAppointmentBtn').addEventListener('click', async function() {
    const form = document.getElementById('addAppointmentForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    try {
        const response = await fetch('/api/appointments/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.status === 201) {
            showAlert('Appointment scheduled successfully!', 'success');
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('addAppointmentModal')).hide();
            loadAppointments();
        } else {
            showAlert(result.message || 'Failed to schedule appointment', 'danger');
        }
    } catch (error) {
        showAlert('Error scheduling appointment', 'danger');
    }
});

// Edit appointment
function editAppointment(appointmentId) {
    const appointment = appointments.find(a => a._id === appointmentId);
    if (!appointment) return;
    
    document.getElementById('editAppointmentId').value = appointment._id;
    document.getElementById('editPetSelect').value = appointment.pet_id;
    document.getElementById('editAppointmentType').value = appointment.appointment_type;
    
    // Format date for datetime-local input
    const date = new Date(appointment.appointment_date);
    const formattedDate = new Date(date.getTime() - date.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    document.getElementById('editAppointmentDate').value = formattedDate;
    
    document.getElementById('editVeterinarian').value = appointment.veterinarian;
    document.getElementById('editClinic').value = appointment.clinic || '';
    document.getElementById('editReason').value = appointment.reason || '';
    document.getElementById('editStatus').value = appointment.status;
    
    new bootstrap.Modal(document.getElementById('editAppointmentModal')).show();
}

// Update appointment
document.getElementById('updateAppointmentBtn').addEventListener('click', async function() {
    const form = document.getElementById('editAppointmentForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    const appointmentId = data.id;
    delete data.id;
    
    try {
        const response = await fetch(`/api/appointments/${appointmentId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showAlert('Appointment updated successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editAppointmentModal')).hide();
            loadAppointments();
        } else {
            const result = await response.json();
            showAlert(result.message, 'danger');
        }
    } catch (error) {
        showAlert('Error updating appointment', 'danger');
    }
});

// Delete appointment
async function deleteAppointment(appointmentId) {
    if (!confirm('Are you sure you want to delete this appointment?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/appointments/${appointmentId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showAlert('Appointment deleted successfully', 'success');
            loadAppointments();
        } else {
            const result = await response.json();
            showAlert(result.message, 'danger');
        }
    } catch (error) {
        showAlert('Error deleting appointment', 'danger');
    }
}
</script>
{% endblock %}