{% extends "base.html" %}

{% block title %}My Pets - PetPal{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-heart-fill text-primary"></i> My Pets</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPetModal">
        <i class="bi bi-plus-circle"></i> Add New Pet
    </button>
</div>

<div id="petsContainer" class="row">
    <!-- Pets will be loaded here -->
</div>

<!-- Add Pet Modal -->
<div class="modal fade" id="addPetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Pet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addPetForm">
                    <div class="mb-3">
                        <label for="petName" class="form-label">Pet Name</label>
                        <input type="text" class="form-control" id="petName" name="name" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="species" class="form-label">Species</label>
                            <select class="form-select" id="species" name="species" required>
                                <option value="">Select Species</option>
                                <option value="Dog">Dog</option>
                                <option value="Cat">Cat</option>
                                <option value="Bird">Bird</option>
                                <option value="Fish">Fish</option>
                                <option value="Rabbit">Rabbit</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="breed" class="form-label">Breed</label>
                            <input type="text" class="form-control" id="breed" name="breed" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="age" class="form-label">Age (years)</label>
                            <input type="number" class="form-control" id="age" name="age" min="0" step="0.1" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="gender" class="form-label">Gender</label>
                            <select class="form-select" id="gender" name="gender">
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="weight" class="form-label">Weight (kg)</label>
                            <input type="number" class="form-control" id="weight" name="weight" min="0" step="0.1">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="color" class="form-label">Color</label>
                            <input type="text" class="form-control" id="color" name="color">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="microchip" class="form-label">Microchip ID</label>
                        <input type="text" class="form-control" id="microchip" name="microchip_id">
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="savePetBtn">Save Pet</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Pet Modal -->
<div class="modal fade" id="editPetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Pet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editPetForm">
                    <input type="hidden" id="editPetId" name="id">
                    <div class="mb-3">
                        <label for="editPetName" class="form-label">Pet Name</label>
                        <input type="text" class="form-control" id="editPetName" name="name" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editSpecies" class="form-label">Species</label>
                            <select class="form-select" id="editSpecies" name="species" required>
                                <option value="">Select Species</option>
                                <option value="Dog">Dog</option>
                                <option value="Cat">Cat</option>
                                <option value="Bird">Bird</option>
                                <option value="Fish">Fish</option>
                                <option value="Rabbit">Rabbit</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editBreed" class="form-label">Breed</label>
                            <input type="text" class="form-control" id="editBreed" name="breed" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editAge" class="form-label">Age (years)</label>
                            <input type="number" class="form-control" id="editAge" name="age" min="0" step="0.1" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editGender" class="form-label">Gender</label>
                            <select class="form-select" id="editGender" name="gender">
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editWeight" class="form-label">Weight (kg)</label>
                            <input type="number" class="form-control" id="editWeight" name="weight" min="0" step="0.1">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editColor" class="form-label">Color</label>
                            <input type="text" class="form-control" id="editColor" name="color">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editMicrochip" class="form-label">Microchip ID</label>
                        <input type="text" class="form-control" id="editMicrochip" name="microchip_id">
                    </div>
                    <div class="mb-3">
                        <label for="editNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="editNotes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updatePetBtn">Update Pet</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let pets = [];

// Load pets on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPets();
});

// Load all pets
async function loadPets() {
    try {
        const response = await fetch('/api/pets/');
        if (response.ok) {
            pets = await response.json();
            displayPets();
        } else {
            showAlert('Failed to load pets', 'danger');
        }
    } catch (error) {
        showAlert('Error loading pets', 'danger');
    }
}

// Display pets
function displayPets() {
    const container = document.getElementById('petsContainer');
    
    if (pets.length === 0) {
        container.innerHTML = `
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="bi bi-heart text-muted" style="font-size: 4rem;"></i>
                    <h3 class="text-muted mt-3">No pets yet</h3>
                    <p class="text-muted">Add your first furry friend to get started!</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPetModal">
                        <i class="bi bi-plus-circle"></i> Add Your First Pet
                    </button>
                </div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = pets.map(pet => `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h5 class="card-title text-primary">
                            <i class="bi bi-heart-fill"></i> ${pet.name}
                        </h5>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="editPet('${pet._id}')">
                                    <i class="bi bi-pencil"></i> Edit
                                </a></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deletePet('${pet._id}')">
                                    <i class="bi bi-trash"></i> Delete
                                </a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Species:</small>
                            <p class="mb-1">${pet.species}</p>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Breed:</small>
                            <p class="mb-1">${pet.breed}</p>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Age:</small>
                            <p class="mb-1">${pet.age} years</p>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Gender:</small>
                            <p class="mb-1">${pet.gender || 'Not specified'}</p>
                        </div>
                        ${pet.weight ? `
                        <div class="col-6">
                            <small class="text-muted">Weight:</small>
                            <p class="mb-1">${pet.weight} kg</p>
                        </div>
                        ` : ''}
                        ${pet.color ? `
                        <div class="col-6">
                            <small class="text-muted">Color:</small>
                            <p class="mb-1">${pet.color}</p>
                        </div>
                        ` : ''}
                    </div>
                    ${pet.notes ? `
                    <div class="mt-2">
                        <small class="text-muted">Notes:</small>
                        <p class="small">${pet.notes}</p>
                    </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `).join('');
}

// Save new pet
document.getElementById('savePetBtn').addEventListener('click', async function() {
    const form = document.getElementById('addPetForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Convert age to number
    if (data.age) {
        data.age = parseFloat(data.age);
    }
    
    // Convert weight to number if provided
    if (data.weight) {
        data.weight = parseFloat(data.weight);
    }
    
    try {
        const response = await fetch('/api/pets/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.status === 201) {
            showAlert('Pet added successfully!', 'success');
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('addPetModal')).hide();
            loadPets();
        } else {
            showAlert(result.message || 'Failed to add pet', 'danger');
        }
    } catch (error) {
        showAlert('Error adding pet', 'danger');
    }
});

// Edit pet
function editPet(petId) {
    const pet = pets.find(p => p._id === petId);
    if (!pet) return;
    
    document.getElementById('editPetId').value = pet._id;
    document.getElementById('editPetName').value = pet.name;
    document.getElementById('editSpecies').value = pet.species;
    document.getElementById('editBreed').value = pet.breed;
    document.getElementById('editAge').value = pet.age;
    document.getElementById('editGender').value = pet.gender || '';
    document.getElementById('editWeight').value = pet.weight || '';
    document.getElementById('editColor').value = pet.color || '';
    document.getElementById('editMicrochip').value = pet.microchip_id || '';
    document.getElementById('editNotes').value = pet.notes || '';
    
    new bootstrap.Modal(document.getElementById('editPetModal')).show();
}

// Update pet
document.getElementById('updatePetBtn').addEventListener('click', async function() {
    const form = document.getElementById('editPetForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    const petId = data.id;
    delete data.id;
    
    try {
        const response = await fetch(`/api/pets/${petId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showAlert('Pet updated successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editPetModal')).hide();
            loadPets();
        } else {
            const result = await response.json();
            showAlert(result.message, 'danger');
        }
    } catch (error) {
        showAlert('Error updating pet', 'danger');
    }
});

// Delete pet
async function deletePet(petId) {
    if (!confirm('Are you sure you want to delete this pet? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/pets/${petId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showAlert('Pet deleted successfully', 'success');
            loadPets();
        } else {
            const result = await response.json();
            showAlert(result.message, 'danger');
        }
    } catch (error) {
        showAlert('Error deleting pet', 'danger');
    }
}
</script>
{% endblock %}